#! /usr/bin/python3

import xmlrpc.client
import ssl
import n4d.responses
import sys
import os


class N4dCrypt:
    
    def __init__(self):
        
        self.commands=["decodevar","encodevar","help"]
        context=ssl._create_unverified_context()
        self.client=xmlrpc.client.ServerProxy("https://localhost:9779",context=context,allow_none=True)
        
    #def __init__

    def eprint(self, *args, **kwargs):
        print(*args, file=sys.stderr, **kwargs)

    #def eprint
    
    def usage(self):
        
        self.eprint("USAGE: n4d-crypt OPTION [PARAMETERS]\n")
        self.eprint("Options:")
        self.eprint("\tdecodevar VAR")
        self.eprint("\tencodevar VAR VALUE\n")
        
    #def usage

    def is_n4d_running(self):
        
        try:
            self.client.get_methods()
            return True
        except:
            return False
        
    #def is_n4d_running
    
    
    def parse_input(self,data):

        if len(data) <2 :
            self.usage()
        else:
            if ( data[1] not in self.commands or data[1]=="help" ):
                self.usage()
            else:
                if not self.is_n4d_running():
                    self.eprint("[!] n4d service is not running")
                    sys.exit(0)

                try:
                    if data[1]=="decodevar":
                        self.decodevar(data[2])
                        
                    if data[1]=="encodevar":
                        if len(data) <3 :
                            self.usage()
                            sys.exit(0)

                        self.encodevar(data[2], data[3])
                        
                except:
                    pass
        
    #def parse_input

    def read_key(self, key_file):
        f=open(key_file)
        key_data=f.readline().strip()
        f.close()
        return key_data
        
    #def readkey
    
    def get_credentials(self):

        user=os.environ["USER"]
        try:
            if user != 'root' :
                ret=self.client.create_ticket(user)

                if self.is_status_ok(ret,silent=True):
                    key = self.read_key("/run/n4d/tickets/%s"%user)
                    return (user,key)

            else:
                key = self.read_key("/etc/n4d/key")
                return key

        except:
            self.eprint("[!] Error reading n4d key to perform the operation")
            sys.exit(0)
            
    #def get_credentials
    
    def is_status_ok(self,ret,silent=True):
        
        if "status" in ret and ret["status"]==n4d.responses.CALL_SUCCESSFUL:
            return True

        if not silent:
            self.eprint("[!] Something went wrong:\n%s"%(str(ret)))
        return False
        
    
    def decodevar(self,vname):
        ret=self.client.decode_variable(self.get_credentials(),"CryptManager",vname)
        if self.is_status_ok(ret,silent=False):
            print(str(ret["return"]))
            
        return -1
        
    #def decodevar

    def encodevar(self,vname,value):
        ret=self.client.encode_variable(self.get_credentials(),"CryptManager",vname, value)
        if self.is_status_ok(ret,silent=False):
            print(str(ret["return"]))
            
        return -1
        
    #def encodevar 
    
    
if __name__=="__main__":
    
    n4dcrypt=N4dCrypt()
    n4dcrypt.parse_input(sys.argv)
    
